{% extends 'scheduling/base.html' %}
{% load static %}
{% block styles %}
    <link rel="stylesheet" href="{% static 'dashboard/css/admin.css' %}" />
{% endblock %}
{% block content %}
<section>
    <h2>Agendamento</h2>
    <div class="card">
        <p><strong>Cliente:</strong> {{ ap.client_name }}</p>
        <p><strong>Telefone:</strong> {{ ap.client_phone }}</p>
        <p><strong>Serviço:</strong> {{ ap.service_label }} - R${{ ap.price }}</p>
        <p><strong>Barbeiro:</strong> {{ ap.barber }}</p>
        <p><strong>Horário:</strong> {{ ap.date|date:'d/m/Y' }} {{ ap.hour|time:'H:i' }}</p>
        <p><strong>Status de pagamento:</strong> {{ ap.get_payment_status_display }}</p>
        <p><strong>Forma de pagamento:</strong> {{ ap.get_payment_method_display }}</p>
        <p><strong>Horário alterado:</strong> {% if ap.rescheduled %}Sim{% else %}Não{% endif %}</p>
        <p><strong>Status do agendamento:</strong> {{ ap.get_status_display }}</p>
    </div>
    <div class="actions">
        <button type="button" class="btn-primary open-shift-modal">Mover horário</button>
    </div>
    {% if ap.status == 'ativo' %}
    <div class="actions" style="margin-top:12px">
        <button type="button" class="btn-danger open-cancel-modal">Cancelar agendamento</button>
    </div>
    {% endif %}
    {% if ap.payment_method == 'cash' and ap.payment_status != 'pago' %}
    <div class="actions" style="margin-top:12px">
        <form method="post" action="{% url 'admin_confirm_cash' ap.id %}">
            {% csrf_token %}
            <button type="submit" class="btn-secondary">Confirmar pagamento em dinheiro</button>
        </form>
    </div>
    {% endif %}
    <form id="shiftForm" method="post" style="display:none">
        {% csrf_token %}
    </form>
    <div id="confirmModal" class="modal" aria-hidden="true">
        <div class="modal-backdrop"></div>
        <div class="modal-dialog">
            <div class="modal-content">
                <h3 id="modalTitle">Mover horário</h3>
                <p id="modalMessage">Selecione a opção desejada.</p>
                <div class="modal-options">
                    <button type="button" class="btn-secondary shift-option" data-url="{% url 'admin_shift_hour' ap.id 'prev' %}" data-message="Confirmar mover para uma hora antes?">Uma hora antes</button>
                    <button type="button" class="btn-secondary shift-option" data-url="{% url 'admin_shift_hour' ap.id 'next' %}" data-message="Confirmar mover para uma hora depois?">Uma hora depois</button>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn-secondary" id="modalCancel">Cancelar</button>
                    <button type="button" class="btn-primary" id="modalConfirm" disabled>Confirmar</button>
                </div>
            </div>
        </div>
    </div>
    <form id="cancelForm" method="post" style="display:none" action="{% url 'admin_cancel_appointment' ap.id %}">
        {% csrf_token %}
        <input type="hidden" name="reason" id="cancelReasonInput" />
    </form>
    <div id="cancelModal" class="modal" aria-hidden="true">
        <div class="modal-backdrop"></div>
        <div class="modal-dialog">
            <div class="modal-content">
                <h3>Cancelar agendamento</h3>
                <p>Confirme o cancelamento e informe um motivo opcional.</p>
                <div style="margin:8px 0">
                    <label for="cancelReason" style="display:block;margin-bottom:4px">Motivo (opcional)</label>
                    <input id="cancelReason" type="text" placeholder="Ex.: imprevisto, indisponibilidade" style="width:100%;padding:8px;border:1px solid var(--border);border-radius:var(--radius)" />
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn-secondary" id="cancelModalCancel">Fechar</button>
                    <button type="button" class="btn-danger" id="cancelModalConfirm">Cancelar agendamento</button>
                </div>
            </div>
        </div>
    </div>
    <p><a href="{% url 'admin_list' %}">Voltar</a></p>
</section>
<script>
document.addEventListener('DOMContentLoaded',function(){
  var modal=document.getElementById('confirmModal');
  var modalMsg=document.getElementById('modalMessage');
  var modalCancel=document.getElementById('modalCancel');
  var modalConfirm=document.getElementById('modalConfirm');
  var shiftForm=document.getElementById('shiftForm');
  var openBtn=document.querySelector('.open-shift-modal');
  var pendingUrl=null;
  if(openBtn&&modal){
    openBtn.addEventListener('click',function(){
      modal.classList.add('show');
      if(modalConfirm){modalConfirm.disabled=true}
      if(modalMsg){modalMsg.textContent='Selecione a opção desejada.'}
    });
  }
  Array.prototype.forEach.call(document.querySelectorAll('.shift-option'),function(opt){
    opt.addEventListener('click',function(){
      pendingUrl=opt.getAttribute('data-url');
      var msg=opt.getAttribute('data-message')||'Confirmar mover?';
      if(modalMsg){modalMsg.textContent=msg}
      Array.prototype.forEach.call(document.querySelectorAll('.shift-option'),function(o){o.classList.remove('selected')});
      opt.classList.add('selected');
      if(modalConfirm){modalConfirm.disabled=false}
    });
  });
  function hide(){
    if(modal){modal.classList.remove('show')}
    pendingUrl=null;
    if(modalConfirm){modalConfirm.disabled=true}
    Array.prototype.forEach.call(document.querySelectorAll('.shift-option'),function(o){o.classList.remove('selected')});
    if(modalMsg){modalMsg.textContent='Selecione a opção desejada.'}
  }
  if(modalCancel){modalCancel.addEventListener('click',hide)}
  var backdrop=modal?modal.querySelector('.modal-backdrop'):null;
  if(backdrop){backdrop.addEventListener('click',hide)}
  if(modalConfirm){
    modalConfirm.addEventListener('click',function(){
      if(shiftForm&&pendingUrl){
        shiftForm.setAttribute('action',pendingUrl);
        if(typeof shiftForm.requestSubmit==='function'){shiftForm.requestSubmit()}else{shiftForm.submit()}
        hide();
      }else{hide()}
    });
  }
  var cancelModal=document.getElementById('cancelModal');
  var openCancel=document.querySelector('.open-cancel-modal');
  var cancelForm=document.getElementById('cancelForm');
  var cancelReason=document.getElementById('cancelReason');
  var cancelReasonInput=document.getElementById('cancelReasonInput');
  var cancelModalCancel=document.getElementById('cancelModalCancel');
  var cancelModalConfirm=document.getElementById('cancelModalConfirm');
  function hideCancel(){
    if(cancelModal){cancelModal.classList.remove('show')}
    if(cancelReason){cancelReason.value=''}
  }
  if(openCancel&&cancelModal){
    openCancel.addEventListener('click',function(){
      cancelModal.classList.add('show');
    });
  }
  var cancelBackdrop=cancelModal?cancelModal.querySelector('.modal-backdrop'):null;
  if(cancelBackdrop){cancelBackdrop.addEventListener('click',hideCancel)}
  if(cancelModalCancel){cancelModalCancel.addEventListener('click',hideCancel)}
  if(cancelModalConfirm){
    cancelModalConfirm.addEventListener('click',function(){
      if(cancelForm){
        if(cancelReasonInput&&cancelReason){cancelReasonInput.value=cancelReason.value||''}
        if(typeof cancelForm.requestSubmit==='function'){cancelForm.requestSubmit()}else{cancelForm.submit()}
        hideCancel();
      }else{hideCancel()}
    });
  }
});
</script>
{% endblock %}

